name: Claude Code Batch Tasks

on:
  workflow_call:
    inputs:
      tasks:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      tasks:
        description: "ã‚¿ã‚¹ã‚¯å®šç¾©JSON"
        required: true
        default: '[{"id":"xxx","name":"test","prompt":"Hello Worldã‚’å‡ºåŠ›ã™ã‚‹JavaScripté–¢æ•°ã‚’ä½œæˆ"}]'

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          echo "matrix<<EOF" >> $GITHUB_OUTPUT
          echo '${{ inputs.tasks }}' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  execute-tasks:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        task: ${{ fromJson(needs.setup.outputs.matrix) }}
      max-parallel: 5
      fail-fast: false # ã‚¨ãƒ©ãƒ¼ã§ã‚‚ä»–ã‚¿ã‚¹ã‚¯ç¶šè¡Œ
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Notion dependencies
        run: npm install
        working-directory: scripts

      - name: Execute Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            ã‚¿ã‚¹ã‚¯: ${{ matrix.task.name }}

            ä»¥ä¸‹ã®è¦ä»¶ã‚’æº€ãŸã™ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„:
            ${{ matrix.task.prompt }}

            å®Ÿè£…å¾Œã€å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚
          max_iterations: 30
        continue-on-error: true

      - name: Get PR URL
        id: get_pr
        if: success()
        run: |
          # æœ€æ–°ã®PRã‚’å–å¾—ï¼ˆClaude CodeãŒä½œæˆã—ãŸPRï¼‰
          PR_URL=$(gh pr list --head "${{ github.ref_name }}" --json url --jq '.[0].url' || echo "")
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Notion Status (Success)
        if: steps.claude.outcome == 'success'
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        run: |
          node scripts/notion_sync.js update \
            "${{ matrix.task.id }}" \
            "Review" \
            "${{ steps.get_pr.outputs.pr_url }}" \
            "null"

      - name: Update Notion Status (Failure)
        if: steps.claude.outcome == 'failure'
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        run: |
          ERROR_MSG="Claude Code execution failed. Check GitHub Actions logs for details."
          node scripts/notion_sync.js update \
            "${{ matrix.task.id }}" \
            "Error" \
            "null" \
            "$ERROR_MSG"

  notify:
    needs: execute-tasks
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install
        working-directory: scripts

      - name: Count Results
        id: count
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          # Reviewã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã‚¿ã‚¹ã‚¯æ•°ã‚’å–å¾—
          REVIEW_COUNT=$(node -e "
            import('@notionhq/client').then(async ({ Client }) => {
              const notion = new Client({ auth: process.env.NOTION_TOKEN });
              const response = await notion.databases.query({
                database_id: process.env.NOTION_DATABASE_ID,
                filter: { property: 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', select: { equals: 'Review' } }
              });
              console.log(response.results.length);
            })
          ")

          # Errorã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã‚¿ã‚¹ã‚¯æ•°ã‚’å–å¾—
          ERROR_COUNT=$(node -e "
            import('@notionhq/client').then(async ({ Client }) => {
              const notion = new Client({ auth: process.env.NOTION_TOKEN });
              const response = await notion.databases.query({
                database_id: process.env.NOTION_DATABASE_ID,
                filter: { property: 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', select: { equals: 'Error' } }
              });
              console.log(response.results.length);
            })
          ")

          echo "review_count=$REVIEW_COUNT" >> $GITHUB_OUTPUT
          echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT

      - name: Slack Notification
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "text": "ğŸ¤– Claude Code ãƒãƒƒãƒå‡¦ç†å®Œäº†",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "Claude Code ãƒãƒƒãƒå‡¦ç†å®Œäº†"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*å®Ÿè¡Œçµæœ:*\n${{ needs.execute-tasks.result }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡:*\n${{ steps.count.outputs.review_count }} ã‚¿ã‚¹ã‚¯"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ã‚¨ãƒ©ãƒ¼:*\n${{ steps.count.outputs.error_count }} ã‚¿ã‚¹ã‚¯"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ github.server_url }}/${{ github.repository }}/pulls|PRã‚’ç¢ºèª> | <https://notion.so/${{ secrets.NOTION_DATABASE_ID }}|Notionã§ç¢ºèª>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
