name: Claude Code Batch Tasks

on:
  workflow_call:
    inputs:
      tasks:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      tasks:
        description: "„Çø„Çπ„ÇØÂÆöÁæ©JSON"
        required: true
        default: '[{"id":"xxx","name":"test","prompt":"Hello World„ÇíÂá∫Âäõ„Åô„ÇãJavaScriptÈñ¢Êï∞„Çí‰ΩúÊàê"}]'

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          echo "matrix=${{ inputs.tasks }}" >> $GITHUB_OUTPUT

  execute-tasks:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        task: ${{ fromJson(needs.setup.outputs.matrix) }}
      max-parallel: 5
      fail-fast: false # „Ç®„É©„Éº„Åß„ÇÇ‰ªñ„Çø„Çπ„ÇØÁ∂öË°å
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Notion dependencies
        run: npm install
        working-directory: scripts

      - name: Execute Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            „Çø„Çπ„ÇØ: ${{ matrix.task.name }}

            ‰ª•‰∏ã„ÅÆË¶Å‰ª∂„ÇíÊ∫Ä„Åü„Åô„Ç≥„Éº„Éâ„ÇíÂÆüË£Ö„Åó„Å¶„Åè„Å†„Åï„ÅÑ:
            ${{ matrix.task.prompt }}

            ÂÆüË£ÖÂæå„ÄÅÂ§âÊõ¥„Çí„Ç≥„Éü„ÉÉ„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          max_iterations: 30
        continue-on-error: true

      - name: Get PR URL
        id: get_pr
        if: success()
        run: |
          # ÊúÄÊñ∞„ÅÆPR„ÇíÂèñÂæóÔºàClaude Code„Åå‰ΩúÊàê„Åó„ÅüPRÔºâ
          PR_URL=$(gh pr list --head "${{ github.ref_name }}" --json url --jq '.[0].url' || echo "")
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Notion Status (Success)
        if: steps.claude.outcome == 'success'
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        run: |
          node scripts/notion_sync.js update \
            "${{ matrix.task.id }}" \
            "Review" \
            "${{ steps.get_pr.outputs.pr_url }}" \
            "null"

      - name: Update Notion Status (Failure)
        if: steps.claude.outcome == 'failure'
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        run: |
          ERROR_MSG="Claude Code execution failed. Check GitHub Actions logs for details."
          node scripts/notion_sync.js update \
            "${{ matrix.task.id }}" \
            "Error" \
            "null" \
            "$ERROR_MSG"

  notify:
    needs: execute-tasks
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install
        working-directory: scripts

      - name: Count Results
        id: count
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          # Review„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆ„Çø„Çπ„ÇØÊï∞„ÇíÂèñÂæó
          REVIEW_COUNT=$(node -e "
            import('@notionhq/client').then(async ({ Client }) => {
              const notion = new Client({ auth: process.env.NOTION_TOKEN });
              const response = await notion.databases.query({
                database_id: process.env.NOTION_DATABASE_ID,
                filter: { property: '„Çπ„ÉÜ„Éº„Çø„Çπ', select: { equals: 'Review' } }
              });
              console.log(response.results.length);
            })
          ")

          # Error„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆ„Çø„Çπ„ÇØÊï∞„ÇíÂèñÂæó
          ERROR_COUNT=$(node -e "
            import('@notionhq/client').then(async ({ Client }) => {
              const notion = new Client({ auth: process.env.NOTION_TOKEN });
              const response = await notion.databases.query({
                database_id: process.env.NOTION_DATABASE_ID,
                filter: { property: '„Çπ„ÉÜ„Éº„Çø„Çπ', select: { equals: 'Error' } }
              });
              console.log(response.results.length);
            })
          ")

          echo "review_count=$REVIEW_COUNT" >> $GITHUB_OUTPUT
          echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT

      - name: Slack Notification
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "text": "ü§ñ Claude Code „Éê„ÉÉ„ÉÅÂá¶ÁêÜÂÆå‰∫Ü",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "Claude Code „Éê„ÉÉ„ÉÅÂá¶ÁêÜÂÆå‰∫Ü"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ÂÆüË°åÁµêÊûú:*\n${{ needs.execute-tasks.result }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*„É¨„Éì„É•„ÉºÂæÖ„Å°:*\n${{ steps.count.outputs.review_count }} „Çø„Çπ„ÇØ"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*„Ç®„É©„Éº:*\n${{ steps.count.outputs.error_count }} „Çø„Çπ„ÇØ"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ github.server_url }}/${{ github.repository }}/pulls|PR„ÇíÁ¢∫Ë™ç> | <https://notion.so/${{ secrets.NOTION_DATABASE_ID }}|Notion„ÅßÁ¢∫Ë™ç>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
